rule CVE_2023_21716 {
meta:
 author = "@amgdgocha - dPhish"
 description = "Detects RTF files that abuse CVE-2023-21716, a heap corruption vulnerability in Microsoft Word RTF parsers that allows attackers to execute remote code (RCE) with the victim's privileges. The detection logic has been created based on the PoC referenced in the meta section, The count in the condition section may be changed if more information becomes available. The rule could be bypassed if the PoC has been modified to write font IDs of 6+ digits."
 references = "https://twitter.com/jduck/status/1632471544935923712, https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716"
strings:
 $rtf_magic_number = {7B 5C 72 74 66 31}
 $rtf_table_sig = /(\{\\f\d{1,5})/ 
condition:
 $rtf_magic_number at 0 and #rtf_table_sig >= 10000
}

rule CVE_2023_21716_intensive {
meta:
 author = "@amgdgocha - dPhish"
 description = "Detects RTF files that abuse CVE-2023-21716, a heap corruption vulnerability in Microsoft Word RTF parsers that allows attackers to execute remote code (RCE) with the victim's privileges. The detection logic has been created based on the PoC referenced in the meta section, The count in the condition section may be changed if more information becomes available. This rule searches for font IDs with numbers of any digit count, making it intensive."
 references = "https://twitter.com/jduck/status/1632471544935923712, https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716"
strings:
 $rtf_magic_number = {7B 5C 72 74 66 31}
 $rtf_table_sig = /(\{\\f\d+)/ 
condition:
 $rtf_magic_number at 0 and #rtf_table_sig >= 10000
}
